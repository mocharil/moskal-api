from fastapi import APIRouter, HTTPException
from models import DashboardRequest
from dashboard_menu.keyword_trends import keyword_trends_query, fill_missing_dates
from utils.functions import About_BQ

router = APIRouter()
from dotenv import load_dotenv
import os

load_dotenv()
BQ_PROJECT_ID = os.getenv("BQ_PROJECT_ID")
BQ_CREDS_LOCATION = os.getenv("BQ_CREDS_LOCATION")

BQ = About_BQ(project_id = BQ_PROJECT_ID, credentials_loc = BQ_CREDS_LOCATION)
@router.post("/api/keyword-trends", tags = ["Dashboard Menu"])
async def get_keyword_trends(request: DashboardRequest):

    dummy_data = [{'post_date': '2025-03-18 00:00:00',
        'total_mentions': 18,
        'total_reach': 302.785,
        'total_positive': 16,
        'total_negative': 1,
        'total_neutral': 1},
        {'post_date': '2025-03-17 00:00:00',
        'total_mentions': 195,
        'total_reach': 1017.3375,
        'total_positive': 139,
        'total_negative': 18,
        'total_neutral': 38},
        {'post_date': '2025-03-16 00:00:00',
        'total_mentions': 138,
        'total_reach': 1009.396212872077,
        'total_positive': 105,
        'total_negative': 6,
        'total_neutral': 27},
        {'post_date': '2025-03-15 00:00:00',
        'total_mentions': 270,
        'total_reach': 1970.6501432575756,
        'total_positive': 196,
        'total_negative': 18,
        'total_neutral': 56},
        {'post_date': '2025-03-14 00:00:00',
        'total_mentions': 329,
        'total_reach': 1317.5548795519483,
        'total_positive': 220,
        'total_negative': 22,
        'total_neutral': 87},
        {'post_date': '2025-03-13 00:00:00',
        'total_mentions': 202,
        'total_reach': 436.677585006579,
        'total_positive': 153,
        'total_negative': 13,
        'total_neutral': 36},
        {'post_date': '2025-03-12 00:00:00',
        'total_mentions': 183,
        'total_reach': 741.096238095238,
        'total_positive': 145,
        'total_negative': 15,
        'total_neutral': 23},
        {'post_date': '2025-03-11 00:00:00',
        'total_mentions': 220,
        'total_reach': 469.8534648289876,
        'total_positive': 179,
        'total_negative': 11,
        'total_neutral': 30},
        {'post_date': '2025-03-10 00:00:00',
        'total_mentions': 188,
        'total_reach': 478.25920011148276,
        'total_positive': 140,
        'total_negative': 17,
        'total_neutral': 31},
        {'post_date': '2025-03-09 00:00:00',
        'total_mentions': 95,
        'total_reach': 497.70132340986015,
        'total_positive': 56,
        'total_negative': 16,
        'total_neutral': 23},
        {'post_date': '2025-03-08 00:00:00',
        'total_mentions': 84,
        'total_reach': 484.1999829545455,
        'total_positive': 50,
        'total_negative': 12,
        'total_neutral': 22},
        {'post_date': '2025-03-07 00:00:00',
        'total_mentions': 230,
        'total_reach': 1211.4084912961562,
        'total_positive': 109,
        'total_negative': 13,
        'total_neutral': 108},
        {'post_date': '2025-03-06 00:00:00',
        'total_mentions': 139,
        'total_reach': 497.5351387787964,
        'total_positive': 87,
        'total_negative': 17,
        'total_neutral': 35},
        {'post_date': '2025-03-05 00:00:00',
        'total_mentions': 53,
        'total_reach': 283.25637820512827,
        'total_positive': 34,
        'total_negative': 6,
        'total_neutral': 13},
        {'post_date': '2025-03-04 00:00:00',
        'total_mentions': 67,
        'total_reach': 461.78538095238105,
        'total_positive': 50,
        'total_negative': 5,
        'total_neutral': 12},
        {'post_date': '2025-03-03 00:00:00',
        'total_mentions': 66,
        'total_reach': 238.1891182081807,
        'total_positive': 40,
        'total_negative': 6,
        'total_neutral': 20},
        {'post_date': '2025-03-02 00:00:00',
        'total_mentions': 28,
        'total_reach': 158.34242577030815,
        'total_positive': 16,
        'total_negative': 5,
        'total_neutral': 7},
        {'post_date': '2025-03-01 00:00:00',
        'total_mentions': 27,
        'total_reach': 60.7820077614379,
        'total_positive': 13,
        'total_negative': 5,
        'total_neutral': 9},
        {'post_date': '2025-02-28 00:00:00',
        'total_mentions': 44,
        'total_reach': 171.44238132094944,
        'total_positive': 22,
        'total_negative': 5,
        'total_neutral': 17},
        {'post_date': '2025-02-27 00:00:00',
        'total_mentions': 44,
        'total_reach': 234.53370708961685,
        'total_positive': 20,
        'total_negative': 5,
        'total_neutral': 19},
        {'post_date': '2025-02-26 00:00:00',
        'total_mentions': 51,
        'total_reach': 262.0814561403509,
        'total_positive': 35,
        'total_negative': 5,
        'total_neutral': 11},
        {'post_date': '2025-02-25 00:00:00',
        'total_mentions': 48,
        'total_reach': 273.12160514923676,
        'total_positive': 26,
        'total_negative': 3,
        'total_neutral': 19},
        {'post_date': '2025-02-24 00:00:00',
        'total_mentions': 59,
        'total_reach': 248.36772877790435,
        'total_positive': 40,
        'total_negative': 3,
        'total_neutral': 15},
        {'post_date': '2025-02-23 00:00:00',
        'total_mentions': 21,
        'total_reach': 169.97100010652557,
        'total_positive': 11,
        'total_negative': 3,
        'total_neutral': 7},
        {'post_date': '2025-02-22 00:00:00',
        'total_mentions': 17,
        'total_reach': 19.206725,
        'total_positive': 12,
        'total_negative': 4,
        'total_neutral': 1},
        {'post_date': '2025-02-21 00:00:00',
        'total_mentions': 44,
        'total_reach': 239.98111137123746,
        'total_positive': 33,
        'total_negative': 8,
        'total_neutral': 3},
        {'post_date': '2025-02-20 00:00:00',
        'total_mentions': 49,
        'total_reach': 518.7782301217302,
        'total_positive': 37,
        'total_negative': 3,
        'total_neutral': 9},
        {'post_date': '2025-02-19 00:00:00',
        'total_mentions': 45,
        'total_reach': 334.662151994302,
        'total_positive': 30,
        'total_negative': 5,
        'total_neutral': 10},
        {'post_date': '2025-02-18 00:00:00',
        'total_mentions': 69,
        'total_reach': 548.1419424971581,
        'total_positive': 39,
        'total_negative': 7,
        'total_neutral': 23},
        {'post_date': '2025-02-17 00:00:00',
        'total_mentions': 50,
        'total_reach': 183.64435665024627,
        'total_positive': 32,
        'total_negative': 10,
        'total_neutral': 8},
        {'post_date': '2025-02-16 00:00:00',
        'total_mentions': 28,
        'total_reach': 87.69425609142434,
        'total_positive': 15,
        'total_negative': 3,
        'total_neutral': 10},
        {'post_date': '2025-02-15 00:00:00',
        'total_mentions': 21,
        'total_reach': 364.9766008064516,
        'total_positive': 7,
        'total_negative': 9,
        'total_neutral': 5}]
    return {"status": "success", "data": dummy_data}


    try:
        # Generate the query
        query = keyword_trends_query(
            keyword=request.keyword,
            sentiment=request.sentiment,
            date_filter=request.date_filter,
            custom_start_date=request.custom_start_date,
            custom_end_date=request.custom_end_date,
            channel=request.channel,
            influence_score_min=request.influence_score_min,
            influence_score_max=request.influence_score_max,
            region=request.region,
            language=request.language,
            importance=request.importance,
            domain=request.domain
        )

        # Execute the query using BigQuery
        df = BQ.to_pull_data(query)

        # Fill missing dates
        result = fill_missing_dates(
            df,
            request.date_filter,
            request.custom_start_date,
            request.custom_end_date
        )

        return {
            "status": "success",
            "data": result
        }

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
